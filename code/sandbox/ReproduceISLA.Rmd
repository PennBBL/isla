---
title: "ISLA_Reproducibility"
output: html_document
---

This document shows how to reproduce ISLA maps for a small sample of participants. The following is just a walk through of the code; to execute it, a working version of the `imco` package is necessary, which currently only works on *singularity*.

```{r, eval=FALSE}
# Libraries, again, available on the singularity docker

library(parallel)
library(methods)
library(stringr)
library(fslr)
library(ANTsR)
library(extrantsr)
library(rlist)
library(dplyr)
library(imco)
library(knitr)
```

Reading in the samples:

```{r, eval=FALSE}
cbf=read.csv("/data/jux/BBL/projects/isla/data/Reproducibility/cbfSample.csv")
reho_alff=read.csv("/data/jux/BBL/projects/isla/data/Reproducibility/restSample.csv")
```

For recreating the CBF maps, we use the participants' cbf images:

```{r, eval=FALSE}
cbfImages = list()
cbfDir = "/data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/asl/voxelwiseMaps_cbf/"
for(scan in 1:nrow(cbf)){
  
  cbfImages[[scan]] = readnii(paste0(cbfDir,cbf[scan, 'scanid'], "_asl_quant_ssT1Std.nii.gz"))
  
}
```

And their GMD images:

```{r, eval=FALSE}
cbf_gmdImages = list()
gmdDir = "/data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/t1struct/voxelwiseMaps_gmd/"

for(scan in 1:nrow(cbf)){
  
  cbf_gmdImages[[scan]] = readnii(paste0(gmdDir,cbf[scan, 'scanid'], "_atropos3class_prob02SubjToTemp2mm.nii.gz"))
}
```

Likewise, for recreating Alf and REHO maps, we do the same:

```{r, eval=FALSE}
#alff
alffImages = list()
alffDir = "/data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/rest/voxelwiseMaps_alff/"

for(scan in 1:nrow(reho_alff)){
  
  alffImages[[scan]] = readnii(paste0(alffDir,reho_alff[scan, 'scanid'], "_alffStd.nii.gz"))
}

#reho
rehoImages=list()
rehoDir = "/data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/rest/voxelwiseMaps_reho/"

for(scan in 1:nrow(reho_alff)){
  
  rehoImages[[scan]] = readnii(paste0(rehoDir,reho_alff[scan, 'scanid'], "_rehoStd.nii.gz"))
}

#corresponding gmd
al_re_gmdImages = list()
for(scan in 1:nrow(reho_alff)){
  
  al_re_gmdImages[[scan]] = readnii(paste0(gmdDir,reho_alff[scan, 'scanid'], "_atropos3class_prob02SubjToTemp2mm.nii.gz"))
}
```

To create a mask for imco calculation, we modify an existing mask image. We set a threshold for the signal at 10% and binarise the signal, then multiply this mask by the Pasl mask. This is done in `fsl` so it's necessary to do so with a shell command (done below by changing the code chunk from R to bash):

```{bash, eval=FALSE}
fslmaths /data/joy/BBL/studies/pnc/template/priors/prior_002_2mm.nii.gz  -thr 0.1 -bin /data/jux/BBL/projects/isla/data/Masks/asl_gm_Mask

fslmaths /data/jux/BBL/projects/isla/data/Masks/asl_gm_Mask -mul /data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/asl/n1601_PcaslCoverageMask.nii.gz /data/jux/BBL/projects/isla/data/Masks/gm10perc_PcaslCoverageMask.nii.gz

fslmaths /data/jux/BBL/projects/isla/data/Masks/asl_gm_Mask -mul /data/joy/BBL/studies/pnc/n1601_dataFreeze/neuroimaging/rest/n1601_RestCoverageMask_20170509.nii.gz /data/jux/BBL/projects/isla/data/Masks/gm10perc_RestCoverageMask.nii.gz
```

Once this is done, read in the mask images:

```{r, eval=FALSE}
cbfMask = readnii("/data/jux/BBL/projects/isla/data/Masks/gm10perc_PCaslCoverageMask.nii.gz")
restMask = readnii("/data/jux/BBL/projects/isla/data/Masks/gm10perc_RestCoverageMask.nii.gz")
```

Running `imco` itself is straightforward:
```{r, eval=FALSE}
#for CBF
for(participant in 1:nrow(cbf)){
  
  makeDir=paste0("/data/jux/BBL/projects/isla/results/Reproducibility/CBF/", cbf[participant,"scanid"])
  system2("mkdir", c("-p",makeDir))
  imco(files=list(cbf_gmdImages[[participant]], cbfImages[[participant]]), brainMask=cbfMask, subMask=NULL, type="regression", ref=1, fwhm=3, thresh=0.005, radius=3, reverse=FALSE, verbose=TRUE, retimg=FALSE, outDir=makeDir)
}

#for Alff
for(participant in 1:nrow(cbf)){
  
  makeDir=paste0("/data/jux/BBL/projects/isla/results/Reproducibility/ALFF/", reho_alff[participant,"scanid"])
  system2("mkdir", c("-p",makeDir))
  imco(files=list(al_re_gmdImages[[participant]], alffImages[[participant]]), brainMask=restMask, subMask=NULL, type="regression", ref=1, fwhm=3, thresh=0.005, radius=3, reverse=FALSE, verbose=TRUE, retimg=FALSE, outDir=makeDir)
}

#for reho
for(participant in 1:nrow(cbf)){
  
  makeDir=paste0("/data/jux/BBL/projects/isla/results/Reproducibility/Reho/", reho_alff[participant,"scanid"])
  system2("mkdir", c("-p",makeDir))
  imco(files=list(al_re_gmdImages[[participant]], rehoImages[[participant]]), brainMask=restMask, subMask=NULL, type="regression", ref=1, fwhm=3, thresh=0.005, radius=3, reverse=FALSE, verbose=TRUE, retimg=FALSE, outDir=makeDir)
}
```

The script that executes everything above is `ReproduceISLA.R`, submitted by `SubmitReproduceISLA.sh`
